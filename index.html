<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&B Sequencer 20</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap');

        :root {
            --neon-green: #39ff14;
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
            --bg-dark: #0a0a0a;
            --panel-bg: #141414;
        }

        body {
            background-color: var(--bg-dark);
            color: #eee;
            font-family: 'Share Tech Mono', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 15px var(--neon-green);
            color: var(--neon-green);
            letter-spacing: 2px;
        }

        .sequencer-container {
            background: var(--panel-bg);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            width: 100%;
            max-width: 940px;
        }

        .btn {
            background: #222;
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            padding: 8px 16px;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .btn:hover {
            background: var(--neon-green);
            color: #000;
            box-shadow: 0 0 12px var(--neon-green);
        }

        .btn.active {
            background: var(--neon-green);
            color: #000;
        }

        .btn-blue { border-color: var(--neon-blue); color: var(--neon-blue); }
        .btn-blue:hover { background: var(--neon-blue); color: #000; box-shadow: 0 0 12px var(--neon-blue); }

        .btn-danger { border-color: var(--neon-pink); color: var(--neon-pink); }
        .btn-danger:hover { background: var(--neon-pink); color: #fff; box-shadow: 0 0 12px var(--neon-pink); }

        select {
            background: #1a1a1a;
            color: var(--neon-blue);
            border: 1px solid var(--neon-blue);
            padding: 8px;
            border-radius: 4px;
            outline: none;
        }

        input[type="range"] {
            accent-color: var(--neon-green);
            cursor: pointer;
        }

        /* Grid Setup - Fixed sizing issue */
        .grid-layout {
            display: grid;
            grid-template-columns: 80px repeat(16, 1fr);
            gap: 4px;
            margin-bottom: 8px;
            align-items: center;
        }

        .track-label {
            font-size: 0.7rem;
            color: #888;
            font-weight: bold;
            text-transform: uppercase;
        }

        .step {
            aspect-ratio: 1/1;
            background: #222;
            border: 1px solid #333;
            border-radius: 2px;
            cursor: pointer;
            transition: transform 0.1s, background 0.1s;
            width: 100%; /* Ensure full width of the cell */
        }

        .step:hover { background: #333; }
        
        /* Visual Beat Grouping - Using borders instead of margins to maintain size */
        .step:nth-child(4n+2) {
            border-left: 2px solid #555;
        }

        .step.active {
            background: var(--neon-green);
            box-shadow: 0 0 8px var(--neon-green);
        }
        
        .row-kick .step.active { background: var(--neon-blue); box-shadow: 0 0 8px var(--neon-blue); }
        .row-snare .step.active { background: var(--neon-pink); box-shadow: 0 0 8px var(--neon-pink); }
        .row-hihat .step.active { background: #ffd700; box-shadow: 0 0 8px #ffd700; }
        .row-openhat .step.active { background: #ff8c00; box-shadow: 0 0 8px #ff8c00; }

        .step.playing {
            transform: scale(1.1);
            border: 1px solid #fff !important;
            z-index: 10;
        }

        .indicator {
            height: 6px;
            background: #1a1a1a;
            border-radius: 2px;
        }
        .indicator.active {
            background: #fff;
            box-shadow: 0 0 10px #fff;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .grid-layout { grid-template-columns: 50px repeat(16, 1fr); gap: 2px; }
            .track-label { font-size: 0.55rem; }
            .sequencer-container { padding: 12px; }
            .btn { padding: 6px 10px; font-size: 0.7rem; }
        }
    </style>
</head>
<body>

    <h1 class="text-3xl font-bold mb-6 text-center">Drum'n'Bass Sequencer</h1>

    <div class="sequencer-container">
        <!-- Main Controls -->
        <div class="flex flex-wrap items-center justify-between gap-4 mb-8">
            <div class="flex gap-2">
                <button id="playBtn" class="btn">▶ PLAY</button>
                <button id="stopBtn" class="btn">■ STOP</button>
                <button id="clearBtn" class="btn btn-danger">CLEAR</button>
                <button id="exportBtn" class="btn btn-blue">MIDI ↓</button>
            </div>
            
            <div class="flex flex-wrap gap-4 items-center">
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-400">BPM</span>
                    <input type="range" id="bpmSlider" min="140" max="190" value="174" class="w-24 sm:w-32">
                    <span id="bpmVal" class="text-neon-blue w-8 text-sm">174</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-400">VOL</span>
                    <input type="range" id="volSlider" min="0" max="100" value="80" class="w-20 sm:w-24">
                </div>
            </div>

            <select id="presetSelect" class="w-full sm:w-auto text-sm">
                <option value="" disabled>Select Pattern...</option>
            </select>
        </div>

        <!-- Pattern Info -->
        <div class="mb-6 text-center">
            <div id="patternName" class="text-neon-blue font-bold text-lg mb-1">Pattern: Loading...</div>
            <div id="descDisplay" class="text-gray-500 text-sm italic h-10 px-4 leading-snug"></div>
        </div>

        <!-- Sequencer Grid -->
        <div class="overflow-x-auto pb-4">
            <div class="min-w-[650px]">
                <!-- Indicators -->
                <div class="grid-layout mb-2" id="indicators-row">
                    <div></div> <!-- Spacer -->
                    <!-- JS will inject indicators here -->
                </div>

                <div id="grid-root">
                    <!-- Rows will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <div class="mt-8 text-gray-600 text-xs max-w-2xl text-center">
        All steps are now perfectly aligned. Kick, Snare, and Hats are synthesized in real-time. Export your patterns to MIDI for use in any DAW.
    </div>

    <script>
        // --- AUDIO ENGINE ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        let masterGain;
        let masterVol = 0.8;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
                masterGain = audioCtx.createGain();
                masterGain.gain.value = masterVol;
                masterGain.connect(audioCtx.destination);
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        // --- SYNTHESIS ---
        const playKick = (time) => {
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.connect(g); g.connect(masterGain);
            osc.frequency.setValueAtTime(150, time);
            osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.5);
            g.gain.setValueAtTime(1, time);
            g.gain.exponentialRampToValueAtTime(0.01, time + 0.5);
            osc.start(time); osc.stop(time + 0.5);
        };

        const playSnare = (time) => {
            const bufSize = audioCtx.sampleRate * 0.2;
            const buffer = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufSize; i++) data[i] = Math.random() * 2 - 1;
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'highpass'; filter.frequency.value = 1000;
            const g = audioCtx.createGain();
            noise.connect(filter); filter.connect(g); g.connect(masterGain);
            g.gain.setValueAtTime(0.8, time);
            g.gain.exponentialRampToValueAtTime(0.01, time + 0.2);
            noise.start(time); noise.stop(time + 0.2);

            const osc = audioCtx.createOscillator();
            const og = audioCtx.createGain();
            osc.connect(og); og.connect(masterGain);
            osc.frequency.setValueAtTime(200, time);
            og.gain.setValueAtTime(0.5, time);
            og.gain.exponentialRampToValueAtTime(0.01, time + 0.1);
            osc.start(time); osc.stop(time + 0.1);
        };

        const playHat = (time, open = false) => {
            const bufSize = audioCtx.sampleRate * 0.3;
            const buffer = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufSize; i++) data[i] = Math.random() * 2 - 1;
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'bandpass'; filter.frequency.value = 10000;
            const g = audioCtx.createGain();
            noise.connect(filter); filter.connect(g); g.connect(masterGain);
            const dur = open ? 0.3 : 0.05;
            g.gain.setValueAtTime(open ? 0.5 : 0.3, time);
            g.gain.exponentialRampToValueAtTime(0.01, time + dur);
            noise.start(time); noise.stop(time + dur);
        };

        // --- SEQUENCER LOGIC ---
        const STEPS = 16;
        const TRACKS = [
            { id: 'openhat', label: 'OH/Ride', color: 'row-openhat' },
            { id: 'hihat', label: 'C-Hat', color: 'row-hihat' },
            { id: 'snare', label: 'Snare', color: 'row-snare' },
            { id: 'kick', label: 'Kick', color: 'row-kick' }
        ];

        let gridState = Array(4).fill().map(() => Array(STEPS).fill(false));
        let isPlaying = false;
        let currentStep = 0;
        let bpm = 174;
        let timerID;
        let nextNoteTime = 0.0;
        const lookahead = 25.0;
        const scheduleAheadTime = 0.1;

        // --- PRESETS ---
        const presets = [
            { name: "1. Classic 2-Step", desc: "The foundation of DnB. Rolling kicks and standard snares.", k:[0,10], s:[4,12], ch:[0,2,4,6,8,10,12,14], oh:[] },
            { name: "2. Liquid Roller", desc: "Dense hats and smooth syncopated kicks for soulful vibes.", k:[0,10,15], s:[4,12], ch:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15], oh:[] },
            { name: "3. The Amen Lite", desc: "Fast shuffle feel inspired by the legendary break.", k:[0,10], s:[4,7,12], ch:[0,2,4,6,8,10,12,14], oh:[15] },
            { name: "4. Techstep Drive", desc: "Heavy focus on 1 and 2 for a mechanical driving force.", k:[0,11], s:[4,12], ch:[2,6,10,14], oh:[0,8] },
            { name: "5. Jump Up Bounce", desc: "Minimalist and bouncy rhythm for heavy basslines.", k:[0,10,14], s:[4,12], ch:[0,8], oh:[4,12] },
            { name: "6. Neuro Technical", desc: "Twitchy hats and precise, tight hits.", k:[0,10], s:[4,12], ch:[2,3,6,7,10,11,14,15], oh:[0,8] },
            { name: "7. Old School Jungle", desc: "Ghost snares and syncopation everywhere.", k:[0,10,14], s:[4,9,12], ch:[0,2,4,6,8,10,12,14], oh:[11] },
            { name: "8. Stepper", desc: "Strict alternating focus between kicks and hats.", k:[0,10], s:[4,12], ch:[0,4,8,12], oh:[2,6,10,14] },
            { name: "9. Half-Time", desc: "Feels like Dubstep at 174 BPM.", k:[0], s:[8], ch:[0,2,4,6,8,10,12,14], oh:[14] },
            { name: "10. Darkside", desc: "Sparse, ominous, and industrial.", k:[0,10], s:[4,12,15], ch:[0,8], oh:[11] },
            { name: "11. Samba Bass", desc: "Bossa nova influence on the low end.", k:[0,7,10], s:[4,12], ch:[0,2,4,6,8,10,12,14], oh:[14] },
            { name: "12. Double Time", desc: "Maximum speed sensation.", k:[0,8,10], s:[4,6,12,14], ch:[0,2,4,6,8,10,12,14], oh:[] },
            { name: "13. Minimal", desc: "Only the essential pulses.", k:[0,10], s:[4,12], ch:[2,10], oh:[] },
            { name: "14. Broken Beat", desc: "Complex off-grid feel.", k:[0,3,11], s:[6,12], ch:[0,2,4,6,8,10,12,14], oh:[0] },
            { name: "15. Hardstep", desc: "Stomp rhythm for heavy dancefloors.", k:[0,8,10], s:[4,12], ch:[0,2,4,6,8,10,12,14], oh:[14] },
            { name: "16. Ghost Roller", desc: "Snares falling in between beats.", k:[0,3,10], s:[4,7,12], ch:[0,2,4,6,8,10,12,14], oh:[] },
            { name: "17. Intelligent", desc: "Atmospheric and complex hat layering.", k:[0,11,14], s:[4,12], ch:[0,1,3,4,6,7,9,10,12,13,15], oh:[] },
            { name: "18. Clownstep Swing", desc: "Aggressive shuffle for energetic leads.", k:[0,3,10], s:[4,12], ch:[2,6,10,14], oh:[0,8] },
            { name: "19. Choppage", desc: "Simulated breakbeat surgery.", k:[0,10,15], s:[2,4,12], ch:[6,8,14], oh:[0] },
            { name: "20. The Full On", desc: "Wall of sound.", k:[0,3,7,10,14], s:[4,9,12], ch:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15], oh:[0,8] }
        ];

        // --- UI RENDER ---
        function createGrid() {
            const root = document.getElementById('grid-root');
            const indRow = document.getElementById('indicators-row');

            // Create indicators
            for (let i = 0; i < STEPS; i++) {
                const div = document.createElement('div');
                div.className = 'indicator';
                div.id = `ind-${i}`;
                indRow.appendChild(div);
            }

            // Create tracks
            TRACKS.forEach((t, rowIdx) => {
                const row = document.createElement('div');
                row.className = `grid-layout ${t.color}`;
                
                const label = document.createElement('div');
                label.className = 'track-label';
                label.innerText = t.label;
                row.appendChild(label);

                for (let i = 0; i < STEPS; i++) {
                    const step = document.createElement('div');
                    step.className = 'step';
                    step.id = `step-${rowIdx}-${i}`;
                    step.addEventListener('click', () => {
                        gridState[rowIdx][i] = !gridState[rowIdx][i];
                        step.classList.toggle('active', gridState[rowIdx][i]);
                        document.getElementById('patternName').innerText = "Pattern: Manual Editing";
                    });
                    row.appendChild(step);
                }
                root.appendChild(row);
            });
        }

        function loadPreset(idx) {
            const p = presets[idx];
            gridState = Array(4).fill().map(() => Array(STEPS).fill(false));
            
            p.oh.forEach(s => gridState[0][s] = true);
            p.ch.forEach(s => gridState[1][s] = true);
            p.s.forEach(s => gridState[2][s] = true);
            p.k.forEach(s => gridState[3][s] = true);

            updateGridUI();
            document.getElementById('patternName').innerText = `Pattern: ${p.name}`;
            document.getElementById('descDisplay').innerText = p.desc;
        }

        function updateGridUI() {
            for (let r = 0; r < 4; r++) {
                for (let c = 0; c < STEPS; c++) {
                    document.getElementById(`step-${r}-${c}`).classList.toggle('active', gridState[r][c]);
                }
            }
        }

        // --- SCHEDULER ---
        function scheduleNote(step, time) {
            setTimeout(() => {
                // UI Highlight
                document.querySelectorAll('.indicator').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.step').forEach(el => el.classList.remove('playing'));
                document.getElementById(`ind-${step}`).classList.add('active');
                for (let r = 0; r < 4; r++) {
                    const s = document.getElementById(`step-${r}-${step}`);
                    if (gridState[r][step]) s.classList.add('playing');
                }
            }, (time - audioCtx.currentTime) * 1000);

            if (gridState[0][step]) playHat(time, true);
            if (gridState[1][step]) playHat(time, false);
            if (gridState[2][step]) playSnare(time);
            if (gridState[3][step]) playKick(time);
        }

        function scheduler() {
            while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
                scheduleNote(currentStep, nextNoteTime);
                nextNoteTime += (60.0 / bpm) / 4;
                currentStep = (currentStep + 1) % STEPS;
            }
            timerID = setTimeout(scheduler, lookahead);
        }

        // --- MIDI EXPORT ---
        function exportMIDI() {
            const PPQ = 480;
            const stepTicks = 120;
            const noteMap = [46, 42, 38, 36]; // OH, CH, SN, KK

            let events = [];
            for (let s = 0; s < STEPS; s++) {
                const tick = s * stepTicks;
                for (let r = 0; r < 4; r++) {
                    if (gridState[r][s]) {
                        events.push({ tick: tick, type: 0x90, note: noteMap[r], vel: 100 });
                        events.push({ tick: tick + 60, type: 0x80, note: noteMap[r], vel: 0 });
                    }
                }
            }
            events.sort((a, b) => a.tick - b.tick);

            let track = [];
            let last = 0;
            events.forEach(e => {
                let delta = e.tick - last;
                if (delta > 127) { track.push(((delta >> 7) & 0x7F) | 0x80); delta &= 0x7F; }
                track.push(delta);
                track.push(e.type | 0x09); track.push(e.note); track.push(e.vel);
                last = e.tick;
            });
            track.push(0x00, 0xFF, 0x2F, 0x00);

            const buffer = new ArrayBuffer(22 + track.length);
            const v = new DataView(buffer);
            v.setUint32(0, 0x4D546864); v.setUint32(4, 6); v.setUint16(8, 0); v.setUint16(10, 1); v.setUint16(12, PPQ);
            v.setUint32(14, 0x4D54726B); v.setUint32(18, track.length);
            const u8 = new Uint8Array(buffer);
            for (let i = 0; i < track.length; i++) u8[22 + i] = track[i];

            const blob = new Blob([u8], { type: 'audio/midi' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'dnb_matrix.mid'; a.click();
        }

        // --- INIT ---
        window.addEventListener('load', () => {
            createGrid();
            
            const sel = document.getElementById('presetSelect');
            presets.forEach((p, i) => {
                const opt = document.createElement('option');
                opt.value = i; opt.innerText = p.name; sel.appendChild(opt);
            });
            sel.addEventListener('change', (e) => loadPreset(e.target.value));

            document.getElementById('playBtn').addEventListener('click', () => {
                if (isPlaying) return;
                initAudio();
                isPlaying = true; currentStep = 0; nextNoteTime = audioCtx.currentTime;
                scheduler();
                document.getElementById('playBtn').classList.add('active');
            });

            document.getElementById('stopBtn').addEventListener('click', () => {
                isPlaying = false; clearTimeout(timerID);
                document.getElementById('playBtn').classList.remove('active');
                document.querySelectorAll('.indicator, .step').forEach(el => el.classList.remove('active', 'playing'));
                updateGridUI();
            });

            document.getElementById('clearBtn').addEventListener('click', () => {
                gridState = Array(4).fill().map(() => Array(STEPS).fill(false));
                updateGridUI();
            });

            document.getElementById('exportBtn').addEventListener('click', exportMIDI);

            document.getElementById('bpmSlider').addEventListener('input', (e) => {
                bpm = parseInt(e.target.value);
                document.getElementById('bpmVal').innerText = bpm;
            });

            document.getElementById('volSlider').addEventListener('input', (e) => {
                masterVol = e.target.value / 100;
                if (masterGain) masterGain.gain.setValueAtTime(masterVol, audioCtx.currentTime);
            });

            loadPreset(0);
        });
    </script>
</body>
</html>
